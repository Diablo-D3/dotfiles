#!/usr/bin/env bash

###
### Boilerplate
###

# Exit immediately if a command exits with a non-zero status
set -e

# If set, the ERR trap is inherited by shell functions
set -E

# Treat unset variables as an error when substituting
set -u

# Return value of a pipeline is the last command to exit with a non-zero status
set -o pipefail

# Mark variables which are modified or created for export
set -a

# Allows patterns which match no files to expand to a null string
shopt -s nullglob

# Allow ** pattern
shopt -s globstar

# Allow extended regular expressions
shopt -s extglob

# Allow spaces in filenames and not explode
# https://dwheeler.com/essays/fixing-unix-linux-filenames.html
IFS="$(printf '\n\t')"

GREEN="$(tput setaf 2)"
BLUE="$(tput setaf 4)"
RESET="$(tput sgr0)"
OFFSET=0

###
### Job Blocks
###

function _start() {
    if [ $OFFSET -ne 0 ]; then
        OFFSET=0
        echo -e ""
    fi

    echo -e "$GREEN==> $1$RESET"
}

function _end() {
    OFFSET=0
    echo -e ""
}

function _status() {
    OFFSET=1
    echo -e "$1"
}

function _verbose() {
    if [ "${VERBOSE+set}" ]; then
        echo -e "$BLUE=>" "$*" "$RESET"
    fi

    eval "$@"
}

###
### Wrappers
###

function _mkdir {
    mkdir -vp "$1"
}

function _ln {
    _mkdir "$(dirname "$2")"
    rm -f "$2"
    if [[ "$2" != "/mnt/c"* ]]; then
        ln -sTv "$1" "$2"
    else
        cp -Tv "$1" "$2"
    fi
}

function _ln_descent {
    SRC_DIR="$1"
    DST_DIR="$2"

    if [[ "$DST_DIR" != */ ]] && [[ "$DST_DIR" != *. ]]; then
        DST_DIR="$DST_DIR/"
    fi

    for SRC in "$SRC_DIR"/**; do
        if [ -f "$SRC" ]; then
            DST="${SRC#$SRC_DIR/}"
            _ln "$SRC" "${DST_DIR}${DST}"
        elif [ -d "$SRC" ]; then
            _mkdir "${DST_DIR}${SRC#$SRC_DIR/}"
        else
            _status "Cannot handle $SRC"
        fi
    done
}

function _sudo() {
    if [[ $(groups "$USER") == *"sudo"* ]]; then
        sudo -E bash -c "source $BASE_DIR/install-lib; $*"
    else
        _status "Cannot become root: " "$@"
    fi
}

###
### OS Wrappers
###

if [ -v WSL ]; then
    export SCOOP="$USERPROFILE/scoop/shims/"
    export SCOOPW="$USERPROFILEW\\scoop\\shims\\"

    function _scoop() {
        SCOOP_BIN="${SCOOP}scoop"

        # Scoop uses a batch file somewhere, pwd cant be a UNC path
        OLDPWD="$(pwd)"
        cd "/mnt/c"

        if [[ "$PATH" != *"scoop"* ]]; then
            export PATH="$PATH:$SCOOP"
        fi

        if [ ! -x "$SCOOP_BIN" ]; then
            _verbose powershell.exe -Command "iwr -useb https://get.scoop.sh | iex"
            _verbose "$SCOOP_BIN" install git
            _verbose "$SCOOP_BIN" bucket add extras
        fi

        _verbose "$SCOOP_BIN" "$@"

        cd "$OLDPWD"
        unset OLDPWD
    }
fi
