#!/usr/bin/env bash

# shellcheck disable=SC1090

set -a
set -e
shopt -s nullglob

BASE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
MODULES_DIR="$BASE_DIR/modules"

source "$BASE_DIR/install-lib"

###
### Stage 1
###

if [ -v "$RESTART" ]; then
  _start "Installing"
else
  _start "Install script changed, restarting"
fi

case "$(uname -a)" in
  *WSL*)
    export WSL="true"
    source "$MODULES_DIR/wsl/stealenv.sh"
    ;;
  *)
  ;;
esac

_end

_start "Update git repos"

CHECKSUM_ORIG=$(git -C "$BASE_DIR" hash-object install)
git -C "$BASE_DIR" pull --force --autostash
CHECKSUM_NEW=$(git -C "$BASE_DIR" hash-object install)

_end

if [ x"$CHECKSUM_ORIG" != x"$CHECKSUM_NEW" ]; then
  RESTART="true" "$BASE_DIR/install"
  exit $?
fi

_start "Remove stale symlinks"

paths=( "$HOME" "$HOME/.config" "$HOME/.local" )

if [ -v $WSL ]; then
  paths+=( "$USERPROFILE" "$APPDATA" "$LOCALAPPDATA" )
fi

for path in "${paths[@]}"; do
  find "$path" -mindepth 1 -maxdepth 2 -xtype l -print0 | xargs -0 -r -t -n 1 unlink
done

unset paths

_end

###
### Stage 2
###

for MODULE_DIR in "$MODULES_DIR"/*/; do
  # remove ending /
  MODULE_DIR="${MODULE_DIR%/}"

  # name of module
  MODULE="${MODULE_DIR#$MODULES_DIR/}"

  # path of config script
  MODULE_SH="${MODULE_DIR/$MODULE.sh}"

  # paths of directories to auto syymlink
  MODULE_HOME="${MODULE_DIR/HOME}"
  MODULE_BIN="${MODULE_DIR/BIN}"

  if ( command -v "$MODULE" >/dev/null 2>&1 || command -v "$MODULE.exe" >/dev/null 2>&1 ); then
    _start "Installing for $MODULE"

    for HOME_SRC in "$MODULE_HOME"/*; do
      HOME_DEST="${HOME_SRC#$MODULE_HOME/}"
      _ln "$HOME_SRC" "$HOME/.$HOME_DEST"
    done

    for BIN_SRC in "$MODULE_BIN"/*; do
      BIN_DEST="${BIN_SRC#$MODULE_HOME/}"
      _ln "$BIN_SRC" "$HOME/bin/$BIN_DEST"
    done

    if [ -f "$MODULE_SH" ]; then
      $MODULE_SH
    fi

    _end
  else
    _status "$MODULE not installed, skipping"
    continue
  fi
done

###
### Stage 3
###

_start "Finished installing"

