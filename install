#!/usr/bin/env bash

# shellcheck disable=SC1090

cd "$(dirname "${BASH_SOURCE[0]}")" || exit
export BASE_DIR="$(pwd)"
export MODULES_DIR="$BASE_DIR/modules"

source "$BASE_DIR/install-lib"

###
### Stage 1
###

if [ -z "${RESTART+unset}" ]; then
  _start "Installing"
  export RESTART=yes
else
  _start "Install script changed, restarting"
fi

_end

_start "Update git repos"

CHECKSUM_ORIG=$(git -C "$BASE_DIR" hash-object install)
git -C "$BASE_DIR" pull --force --autostash --rebase
CHECKSUM_NEW=$(git -C "$BASE_DIR" hash-object install)

_end

if [ "$CHECKSUM_ORIG" != "$CHECKSUM_NEW" ]; then
  "$BASE_DIR/install"
  exit $?
fi

_start "Remove stale symlinks"

find "$HOME" -mindepth 1 -name ".*" -xtype l -print0 | xargs -0 -r -t -n 1 unlink
find "$HOME/bin" -mindepth 1 -xtype l -print0 | xargs -0 -r -t -n 1 unlink

unset paths

_end

###
### Stage 2
###

case "$(uname -a)" in
  *WSL*)
    _start "Installing for wsl"

    export WSL="true"
    export MODULE_DIR="$MODULES_DIR/wsl"

    "$MODULES_DIR/wsl/stealenv.sh"
    source "$HOME/.bashrc.win"

    "$MODULES_DIR/wsl.sh"

    _end
    ;;
  *) ;;

esac

###
### Stage 3
###

for MODULE_DIR in "$MODULES_DIR"/*/; do
  # remove ending /
  MODULE_DIR="${MODULE_DIR%/}"

  # name of module
  MODULE="${MODULE_DIR#$MODULES_DIR/}"

  # path of config script
  MODULE_SH="$MODULES_DIR/$MODULE.sh"

  # paths of directories to auto symlink
  MODULE_HOME="$MODULE_DIR/HOME"
  MODULE_BIN="$MODULE_DIR/BIN"
  MODULE_ETC="$MODULE_DIR/ETC"

  # already processed it earlier
  [[ "$MODULE" = "wsl" ]] && continue

  if (command -v "$MODULE" >/dev/null 2>&1 || command -v "$MODULE.exe" >/dev/null 2>&1); then
    _start "Installing for $MODULE"

    _ln_descent "$MODULE_HOME" "$HOME/."
    _ln_descent "$MODULE_BIN" "$HOME/bin/"
    _sudo _ln_descent "$MODULE_ETC" "/etc/"

    if [ -f "$MODULE_SH" ]; then
      "$MODULE_SH"
    fi

    _end
  else
    _status "$MODULE not installed, skipping"
    continue
  fi
done

###
### Stage 3
###

_start "Finished installing"
_end
