#!/usr/bin/env bash

# shellcheck disable=SC1090

set -a
set -e
shopt -s extglob

BASE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

DOTBOT_DIR="dotbot"
DOTBOT_BIN="bin/dotbot"
DOTBOT="${BASE_DIR}/${DOTBOT_DIR}/${DOTBOT_BIN}"

MODULES_DIR="${BASE_DIR}/modules"

export STATUS_OFFSET=0
. "$BASE_DIR/install-lib"

# Stage 1
status_msg "Starting..."

case "$(uname -a)" in
  *WSL*)
    OS="win"
    ./modules/wsl/stealenv.sh
    . ~/.bashrc.local
    ;;
  *)
  ;;
esac

if [ x"${OS}" != x ]; then
  status_warn "Discovered platform ${OS}"
fi

cd "${BASE_DIR}"
git -C "${DOTBOT_DIR}" submodule sync --quiet --recursive
git submodule update --init --recursive "${DOTBOT_DIR}"
"${DOTBOT}" -d "${BASE_DIR}" -c "install.conf.yaml" "${@}"

# Stage 2
for MODULE_DIR in "${MODULES_DIR}"/*/; do
  MODULE_DIR=${MODULE_DIR%/}
  MODULE=${MODULE_DIR#$MODULES_DIR/}

  if ( command -v "${MODULE}" >/dev/null 2>&1 || command -v "${MODULE}.exe" >/dev/null 2>&1 ); then
    ANY_CONF_YAML="${MODULES_DIR}/${MODULE}.any.conf.yaml"
    ANY_CONF_SH="${MODULES_DIR}/${MODULE}.any.sh"
    OS_CONF_YAML="${MODULES_DIR}/${MODULE}.${OS}.conf.yaml" 
    ANY_CONF_SH="${MODULES_DIR}/${MODULE}.${OS}.sh"

    if [ -f "${ANY_CONF_YAML}" ]; then
      status_msg "Installing ${ANY_CONF_YAML}..."
      "${DOTBOT}" -d "${MODULES_DIR}" -c "${ANY_CONF_YAML}" "${@}"
    fi

    if [ -f "${ANY_CONF_SH}" ]; then
      status_msg "Installing ${ANY_CONF_SH}..."
      $ANY_CONF_SH
    fi

    if [ -f "${OS_CONF_YAML}" ]; then
      status_msg "Installing ${OS_CONF_YAML}..."
      "${DOTBOT}" -d "${MODULES_DIR}" -c "${OS_CONF_YAML}" "${@}"
    fi

    if [ -f "${OS_CONF_SH}" ]; then
      status_msg "Installing ${OS_CONF_SH}..."
      $OS_CONF_YAML
    fi

  else
    status_warn "${MODULE} not installed, skipping"
    continue
  fi
done

# Stage 3
status_msg "Finishing..."
"${DOTBOT}" -d "${BASE_DIR}" -c "end.conf.yaml" "${@}"

status_msg "Finished installing"
