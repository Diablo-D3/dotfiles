#!/usr/bin/env bash

# shellcheck disable=SC1090

cd "$(dirname "${BASH_SOURCE[0]}")" || exit
BASE_DIR="$(pwd)"
export BASE_DIR

export MODULES_DIR="$BASE_DIR/modules"

source "$BASE_DIR/install-lib"

###
### Stage 1: Update self, do housekeeping
###

if [ -z "${RESTART+unset}" ]; then
  _start "Installing"
  export RESTART=yes
else
  _start "Install script changed, restarting"
fi

_end

_start "Update git repos"

CHECKSUM_ORIG=$(git -C "$BASE_DIR" hash-object install)
git -C "$BASE_DIR" pull --force --autostash --rebase
CHECKSUM_NEW=$(git -C "$BASE_DIR" hash-object install)

_end

if [ "$CHECKSUM_ORIG" != "$CHECKSUM_NEW" ]; then
  "$BASE_DIR/install"
  exit $?
fi

_start "Remove stale symlinks"

find "$HOME" -mindepth 1 -name ".*" -xtype l -print0 | xargs -0 -r -t -n 1 unlink
find "$HOME/bin" -mindepth 1 -xtype l -print0 | xargs -0 -r -t -n 1 unlink

unset paths

_end

###
### Stage 2: Build list of modules
###

_start "Module detection"

declare -a MODULES

UNAME="$(uname -a)"

if (command -v "lsb_release" >/dev/null 2>&1); then
  LINUX="$(lsb_release -i -s)"
else
  LINUX=""
fi

# Early OS pass
if [[ "$UNAME" == *"WSL"* ]]; then
  _status "Discovered WSL"

  MODULES+=("os-wsl")

  export WSL="true"
  "$MODULES_DIR/os-wsl/stealenv.sh"
  source "$HOME/.bashrc.win"

  # No good place to actually define these
  SCOOP_DIR="$USERPROFILE/scoop/shims"
  SCOOP="${SCOOP_DIR}/scoop"
fi

# Add non-OS modules
for MODULE in "$MODULES_DIR/"!(os)*/; do
  # remove "modules/" prefix and "/" suffix
  MODULE="${MODULE#$MODULES_DIR/}"
  MODULE="${MODULE%/}"

  if (command -v "$MODULE" >/dev/null 2>&1 || command -v "$MODULE.exe" >/dev/null 2>&1); then
    _status "Discovered $MODULE"
    MODULES+=("$MODULE")
  fi
done

# Late OS pass
if [ "$LINUX" != "" ]; then
  _status "Discovered $LINUX"

  # make lowercase
  MODULES+=("os-${LINUX,,}")
fi

###
### Stage 3: Install modules
###

for MODULE in "${MODULES[@]}"; do
  # reconstitute directory of module
  MODULE_DIR="$MODULES_DIR/$MODULE"

  # path of config script
  MODULE_SH="$MODULES_DIR/$MODULE.sh"

  # paths of directories to auto symlink
  MODULE_HOME="$MODULE_DIR/HOME"
  MODULE_BIN="$MODULE_DIR/BIN"
  MODULE_ETC="$MODULE_DIR/ETC"

  _start "Installing for $MODULE"

  _ln_descent "$MODULE_HOME" "$HOME/."
  _ln_descent "$MODULE_BIN" "$HOME/bin/"
  _sudo _ln_descent "$MODULE_ETC" "/etc/"

  if [ -f "$MODULE_SH" ]; then
    "$MODULE_SH"
  fi

  _end
done

###
### Stage 4: Final tasks
###

_start "Finished installing"
_end
