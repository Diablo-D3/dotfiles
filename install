#!/usr/bin/env bash

# shellcheck disable=SC1090

export BASE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export MODULES_DIR="$BASE_DIR/modules"

# Early WSL detect and env inheritence
case "$(uname -a)" in
  *WSL*)
    OLDPATH="$PATH"

    export WSL="true"
    source "$MODULES_DIR/wsl/stealenv.sh"

    if [[ $OLDPATH == *"/mnt/c"* ]]; then
      PATH="$OLDPATH"
    else
      PATH="$OLDPATH:$PATH"
    fi
    ;;
  *) ;;
esac

source "$BASE_DIR/install-lib"

###
### Stage 1
###

if [ -z ${RESTART+x} ]; then
  _start "Installing"
  export RESTART=yes
else
  _start "Install script changed, restarting"
fi

_end

_start "Update git repos"

CHECKSUM_ORIG=$(git -C "$BASE_DIR" hash-object install)
git -C "$BASE_DIR" pull --force --autostash
CHECKSUM_NEW=$(git -C "$BASE_DIR" hash-object install)

_end

if [ "$CHECKSUM_ORIG" != "$CHECKSUM_NEW" ]; then
  "$BASE_DIR/install"
  exit $?
fi

_start "Remove stale symlinks"

find "$HOME" -mindepth 1 -name ".*" -xtype l -print0 | xargs -0 -r -t -n 1 unlink
find "$HOME/bin" -mindepth 1 -xtype l -print0 | xargs -0 -r -t -n 1 unlink

unset paths

_end

###
### Stage 2
###

for MODULE_DIR in "$MODULES_DIR"/*/; do
  # remove ending /
  MODULE_DIR="${MODULE_DIR%/}"

  # name of module
  MODULE="${MODULE_DIR#$MODULES_DIR/}"

  # path of config script
  MODULE_SH="$MODULES_DIR/$MODULE.sh"

  # paths of directories to auto symlink
  MODULE_HOME="$MODULE_DIR/HOME"
  MODULE_BIN="$MODULE_DIR/BIN"

  if (command -v "$MODULE" >/dev/null 2>&1 || command -v "$MODULE.exe" >/dev/null 2>&1); then
    _start "Installing for $MODULE"

    _ln_descent "$MODULE_HOME" "$HOME/."
    _ln_descent "$MODULE_BIN" "$HOME/bin/"

    if [ -f "$MODULE_SH" ]; then
      "$MODULE_SH"
    fi

    _end
  else
    _status "$MODULE not installed, skipping"
    continue
  fi
done

###
### Stage 3
###

_start "Finished installing"
_end
